<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Your Cart | Coffee Haven</title>
  <link rel="stylesheet" href="css/style.css" />
</head>
<body>

<header>
  <a class="logo">‚òï Coffee Haven</a>
  <nav class="navbar">
    <a href="index.html">Home</a>
    <a href="menu.html">Menu</a>
    <a href="cart.html" class="active">Cart <span id="cart-count">0</span></a>

    <div id="signin-wrapper">
      <a id="signin-btn">Sign In</a>
      <div class="dropdown" id="dropdown-menu">
        <button id="signout-btn">Sign Out</button>
      </div>
    </div>
  </nav>
</header>

<!-- ===== Cart Section ===== -->
<div class="cart-page">
  <h2>üõí Your Cart</h2>
  <div class="cart-items-container" id="cart-items"></div>

  <div class="cart-summary">
    <h3>Total: ‚Çπ<span id="cart-total">0.00</span></h3>
    <button class="back-btn" onclick="window.location.href='menu.html'">‚Üê Continue Shopping</button>
    <button id="checkout-btn">Proceed to Checkout</button>
  </div>
</div>

<!-- ===== Sign In Modal ===== -->
<div id="signin-modal" class="modal">
  <div class="modal-content">
    <span class="close-btn">&times;</span>

    <h2 id="modal-title">Sign In</h2>
    <input type="email" id="email" placeholder="Email" />
    <input type="password" id="password" placeholder="Password" />
    <button id="action-btn">Sign In</button>
    <p style="margin-top:10px;">
      <span id="toggle-text">New here?</span>
      <a href="#" id="toggle-auth">Create Account</a>
    </p>
  </div>
</div>

<footer>
  <p>¬© 2025 Coffee Haven | Freshly brewed happiness ‚òï</p>
</footer>

<script>
  const API_URL = "http://localhost:5000";

  // DOM Elements
  const modal = document.getElementById("signin-modal");
  const signinBtn = document.getElementById("signin-btn");
  const signoutBtn = document.getElementById("signout-btn");
  const dropdown = document.getElementById("dropdown-menu");
  const toggleAuth = document.getElementById("toggle-auth");
  const toggleText = document.getElementById("toggle-text");
  const actionBtn = document.getElementById("action-btn");
  const modalTitle = document.getElementById("modal-title");
  const emailInput = document.getElementById("email");
  const passInput = document.getElementById("password");
  const cartCount = document.getElementById("cart-count");
  const cartItemsContainer = document.getElementById("cart-items");
  const cartTotal = document.getElementById("cart-total");
  const checkoutBtn = document.getElementById("checkout-btn");

  let isSignup = false;
  let cart = JSON.parse(localStorage.getItem("cart")) || [];

  // Update navigation based on login state
  function updateNavbar() {
    const user = localStorage.getItem("loggedUser");
    if (user) {
      signinBtn.textContent = user.split("@")[0];
      signinBtn.style.background = "#4caf50";
    } else {
      signinBtn.textContent = "Sign In";
      signinBtn.style.background = "#6f4e37";
    }
  }

  // Update cart count
  function updateCartCount() {
    const totalItems = cart.reduce((sum, item) => sum + item.quantity, 0);
    cartCount.textContent = totalItems;
  }

  // Render cart items
  function renderCart() {
    cartItemsContainer.innerHTML = "";
    let total = 0;

    if (cart.length === 0) {
      cartItemsContainer.innerHTML = '<p style="text-align: center; padding: 40px; color: #777;">Your cart is empty ‚òï</p>';
      cartTotal.textContent = "0.00";
      updateCartCount();
      return;
    }

    cart.forEach((item, index) => {
      const subtotal = item.price * item.quantity;
      total += subtotal;

      const cartItem = document.createElement("div");
      cartItem.className = "cart-item";
      cartItem.innerHTML = `
        <img src="${item.image}" alt="${item.name}">
        <div class="item-details">
          <h4>${item.name}</h4>
          <p>Price: ‚Çπ${item.price.toFixed(2)}</p>
        </div>
        <div class="item-actions">
          <select class="qty-select" data-index="${index}">
            ${Array.from({length: 10}, (_, i) => 
              `<option value="${i+1}" ${item.quantity === i+1 ? 'selected' : ''}>${i+1}</option>`
            ).join('')}
          </select>
          <button class="remove-btn" data-index="${index}">Remove</button>
        </div>
      `;
      cartItemsContainer.appendChild(cartItem);
    });

    cartTotal.textContent = total.toFixed(2);
    updateCartCount();
    localStorage.setItem("cart", JSON.stringify(cart));
  }

  // Initialize page
  document.addEventListener('DOMContentLoaded', function() {
    updateNavbar();
    renderCart();
  });

  // Sign in button click handler
  signinBtn.onclick = () => {
    const user = localStorage.getItem("loggedUser");
    if (user) {
      dropdown.style.display = dropdown.style.display === "block" ? "none" : "block";
    } else {
      modal.style.display = "flex";
    }
  };

  // Modal close
  document.querySelector(".close-btn").onclick = () => {
    modal.style.display = "none";
  };

  // Toggle between sign in and sign up
  toggleAuth.onclick = (e) => {
    e.preventDefault();
    isSignup = !isSignup;
    modalTitle.textContent = isSignup ? "Create Account" : "Sign In";
    actionBtn.textContent = isSignup ? "Register" : "Sign In";
    toggleText.textContent = isSignup ? "Already have an account?" : "New here?";
    toggleAuth.textContent = isSignup ? "Sign In" : "Create Account";
  };

  // Sign in/register action
  actionBtn.onclick = async () => {
    const email = emailInput.value.trim();
    const password = passInput.value.trim();
    if (!email || !password) return alert("Fill all fields");

    const endpoint = isSignup ? "/signup" : "/login";
    try {
      const res = await fetch(API_URL + endpoint, {
        method: "POST",
        headers: { "Content-Type": "application/json"},
        body: JSON.stringify({ email, password })
      });
      const data = await res.json();

      if (!data.success) return alert(data.message);

      localStorage.setItem("loggedUser", email);
      modal.style.display = "none";
      updateNavbar();
      emailInput.value = "";
      passInput.value = "";
      
      // If there was a pending checkout, proceed
      if (window.pendingCheckout) {
        proceedCheckout();
        window.pendingCheckout = false;
      }
    } catch (error) {
      alert("Server error. Please try again.");
    }
  };

  // Sign out
  signoutBtn.onclick = () => {
    localStorage.removeItem("loggedUser");
    dropdown.style.display = "none";
    updateNavbar();
  };

  // Close dropdown when clicking outside
  document.addEventListener('click', function(event) {
    if (!event.target.closest('#signin-wrapper')) {
      dropdown.style.display = 'none';
    }
  });

  // Cart quantity change
  cartItemsContainer.addEventListener('change', function(e) {
    if (e.target.classList.contains('qty-select')) {
      const index = e.target.dataset.index;
      const newQuantity = parseInt(e.target.value);
      cart[index].quantity = newQuantity;
      localStorage.setItem("cart", JSON.stringify(cart));
      renderCart();
    }
  });

  // Remove item from cart
  cartItemsContainer.addEventListener('click', function(e) {
    if (e.target.classList.contains('remove-btn')) {
      const index = e.target.dataset.index;
      cart.splice(index, 1);
      localStorage.setItem("cart", JSON.stringify(cart));
      renderCart();
    }
  });

  // Checkout functionality
  checkoutBtn.onclick = () => {
    if (cart.length === 0) {
      alert("Your cart is empty!");
      return;
    }

    const user = localStorage.getItem("loggedUser");
    if (!user) {
      window.pendingCheckout = true;
      modal.style.display = "flex";
      return;
    }

    proceedCheckout();
  };

  function proceedCheckout() {
    const total = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
    alert(`‚úÖ Order placed successfully!\nTotal: ‚Çπ${total.toFixed(2)}\nThank you for shopping with Coffee Haven! ‚òï`);
    
    // Clear cart after successful checkout
    cart = [];
    localStorage.setItem("cart", JSON.stringify(cart));
    renderCart();
  }

  // Initial calls
  updateNavbar();
  renderCart();
</script>

</body>
</html>
